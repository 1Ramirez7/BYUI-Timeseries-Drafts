---
title: "Chapter 1: Lesson 2"
subtitle: "Plots Trends, and Seasonal Variation"
format: html
editor: source
---

```{r}
#| include: false
if (!require("pacman")) install.packages("pacman")
pacman::p_load("tsibble", "fable", 
    "feasts", "tsibbledata",
    "fable.prophet", "tidyverse",
    "patchwork",
    "ggthemes", "see"   # for okabeito color scheme
    )
pacman::p_load(ggokabeito, kableExtra, stringr, lubridate)
```


## Learning Outcomes

<details>
<summary>Use technical language to describe the main features of time series data</summary>
    -   Define time series analysis
    -   Define time series
    -   Define sampling interval
    -   Define serial dependence or autocorrelation
    -   Define a time series trend
    -   Define seasonal variation
    -   Define cycle
</details>

<details>
<summary>Use R to describe key features of time series data</summary>
    -   Create a seasonal summmary of a time series
</details>
<details>
<summary>Plot time series data to visualize trends, seasonal patterns, and potential outliers</summary>
    -   Plot a "ts" object
    -   Combine multiple "ts" objects into a single plot ????????????????????????????????????????????????????????????????????????-TIED-TO-CORRELATION-IS-NOT-CAUSATION-?????????????????? When?
    -   Make boxplots to examine distribution of values within each season
</details>
<details>
<summary>Explain the purpose and limitations of forecasting</summary>
    -   Define lead time
</details>

## Preparation

-   Read Sections 1.1-1.4 and 1.5.1-1.5.3
 
## Learning Journal Exchange (15 mins)

-   Review another student's journal
-   What would you add to your learning journal after reading your partner's?
-   What would you recommend your partner add to their learning journal?
-   Sign the Learning Journal review sheet for your peer


## Vocabulary and nomenclature Activity (15 mins)

Match the definitions on the left with the terms on the right.

<!-- https://bookdown.org/yihui/rmarkdown-cookbook/multi-column.html -->

::: {style="display: flex;"}
<div>

1.  A figure with time on the horizontal axis and the value of a random variable on the vertical axis
2.  A systematic change in a time series that does not appear to be periodic
3.  Repeated pattern within each year (or any other time period)
4.  Repeated pattern that does not correspond to some fixed natural period
5.  Observations in which values are related to lagged observations of the same
6.  Random trend that does not follow a discernible or predictable pattern
7.  Can be modeled with mathematical functions, facilitating the long-term prediction of the behavior
8.  Number of observations of a time series
9.  Discrete observations of a time series, taken at times $1, 2, \ldots, n$.
10. Lead time
11. Forecast made at time $t$ for a future value $k$ time units in the future
12. Additive decomposition
13. Additive decomposition model for $\log(x_t)$
14. Multiplicative model
15. Centered moving average
16. Estimate of monthly additive effect
17. Estimate of monthly multipliciative effect
18. Seasonally adjusted mean for the month corresponding to time $t$
19. Seasonal adjusted series (additive seasonal effect)
20. Seasonal adjusted series (additive seasonal effect)
21. The trend as observed at time $t$
22. The seasonal effect, as observed at time $t$
23. The error term (a sequence of correlated random variables with mean zero), as observed at time $t$
</div>

<div>
A.  Cycles
B.  Correlated (Serially Dependent) Data
C.  Deterministic Trend
D.  Seasonal Variations
E.  Stochastic Trend
F.  Time Plot
G.  Trends
H.  $n$
I.  $\{x_t\}$
J.  $k$
K.  $\hat x_{t+k \mid t}$
L.  $m_t$
M.  $\hat m_t$
N.  $s_t$
O.  $\hat s_t = x_t - \hat m_t$
P.  $\hat s_t = \dfrac{x_t}{\hat m_t}$
Q.  $\bar s_t$
R.  $z_t$
S.  $x_t = m_t + s_t + z_t$
T.  $x_t = m_t \cdot s_t + z_t$
U.  $\log(x_t) = m_t + s_t + z_t$
V.  $x_t - \bar s_t$
W.  $\frac{x_t}{\bar s_t}$
</div>

:::

where $\hat m_t = \dfrac{\frac{1}{2}x_{t-6} + x_{t-5} + \cdots + x_{t-1} + x_t + x_{t+1} + \cdot + x_{t+5} + \frac{1}{2} x_{t+6}}{12}$.

::: callout-warning
Understand the difference between these models

Textbook model: $$ x_t = m_t \cdot s_t + z_t $$

R's model: $$ x_t = m_t \cdot s_t \cdot z_t $$
:::

## POSSIBLY: DEMONSTRATE THAT TWO UNRELATED TIME SERIES WILL BE CORRELATED IF THEY BOTH CONTAIN A TREND----------

## Hands-on Exercise: Exploring a time series in R (Google Trends: Chocolate) (20 min)

::: callout-caution
We need to add a link to the chocolate search trends data here, together with the code to analyze them
:::

Do the following.

-   Import the chocolate search data and convert to tsibble format
-   Compute summary statistics for this time series data
-   Aggregate time series data in a tsibble to the annual level to remove seasonal variation and visualize the trend.
-   What do you observe in the trend? What do you suspect is causing this trend?
-   Create a box plot of seasonal values, with one box plot per month. What do you observe? Which months tend to have more searches? Can you provide an explanation for this?
-   Demonstrate decomposition of the chocolate search data; show trend, seasonality, and residual
-   How does the trend and seasonality compare to your observations above?
-   What do you observe in the residual? Are there any unusual spikes? Use Google to try to determine what may have caused the usual spikes.

## Hands-on Exercise: Exploring simulated time series data (5 min)

::: callout-caution
Insert a simulation of a time series that can be revised to allow students to see effects of inputs on the TS. (Here is an idea below.)
:::

```{r}
#| warning: false

# Set random seed for reproducibility
set.seed(1234) 

num_years <- 10
n <- 12 * num_years

sigma <- .75
a <- 0.05
b <- .5
c <- .9
x <- rep(0,n)
e <- rnorm(n, 0, sigma)
time_seq <- seq(1,n)

# Get date
year_seq <- lubridate::year(today()) - num_years  + (time_seq - 1) %/% 12
month_seq <- (time_seq - 1) %% 12 + 1
date_seq <- ymd(paste0(year_seq,"-",month_seq,"-01"))

# Get data
for (i in 2:n) {
  x[i] <- a * i + b * sin(i / 12 * 2 * pi * 3)  + c * cos(i / 12 * 2 * pi * 2) + e[i]
}

x_df <- data.frame(x = x)

start_year <- lubridate::year(today()) - num_years
start_date <- lubridate::ymd(paste0(start_year,"-01-01"))

# start_date <- lubridate::ymd("1958-01-01")
date_seq <- seq(start_date,
    start_date + months(nrow(x_df)-1),
    by = "1 months")

x_df_ts <- x_df |>
    mutate(
        date = date_seq,
        month = tsibble::yearmonth(date)) |>
    as_tsibble(index = month)

x_decompose <- x_df_ts |>
    model(feasts::classical_decomposition(x,
        type = "add"))  |>
    components()

autoplot(x_decompose)
```

-   Demonstrate decomposition of simulated ts data in Quarto notebook; show trend, seasonality, and residual
-   Make changes to the simulated data and observe the effect on the plots

## Recap (5 mins)

-   Review objectives and key concepts
-   Clarify questions on time series data
