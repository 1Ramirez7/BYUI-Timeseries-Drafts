---
title: "Harmonic Seasonal Variables"
subtitle: "Chapter 5: Lesson 2"
format: html
editor: source
sidebar: false
---

```{r}
#| include: false
source("common_functions.R")
```

```{=html}
<script type="text/javascript">
 function showhide(id) {
    var e = document.getElementById(id);
    e.style.display = (e.style.display == 'block') ? 'none' : 'block';
 }
 
 function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";
 }    
</script>
```


## Learning Outcomes

{{< include outcomes/chapter_5_lesson_2_outcomes.qmd >}}




## Preparation

-   Read Section 5.6



## Learning Journal Exchange (10 min)

-   Review another student's journal

-   What would you add to your learning journal after reading another student's?

-   What would you recommend the other student add to their learning journal?

-   Sign the Learning Journal review sheet for your peer



## Class Activity: XXXXXXXXXXXXXXXXXXXXXX (xxx min)

### Review of Trigonometry

Consider the sine wave with the following parameters:

-   $A$:$~~$    the amplitude, 
-   $f$:$~~~$    the frequency or the number of cycles per sampling interval, and
-   $\phi$:$~~~$ the phase shift.

$$
  A \sin ( 2 \pi f t + \phi )
$$

Here is an interactive plot of this function. Adjust the values of $A$, $f$, and $\phi$ to see their effect on the function.

<iframe src="https://www.desmos.com/calculator/sgbxo2c0hx" width="750" height="500" style="border: 1px solid #ccc" frameborder=0></iframe>

One of the trigonometric sum and difference identities is:

\begin{align*}
  \sin(\theta + \phi) 
    &= \sin(\theta)\cos(\phi)  + \cos(\theta)\sin(\phi)  \\
    &= \cos(\phi) \sin(\theta) + \sin(\phi) \cos(\theta) 
\end{align*}

We apply this to our sine function.

\begin{align*}
  A \sin ( 2 \pi f t + \phi )
    &= \underbrace{A \cos( \phi )}_{\alpha_s} \cdot \sin ( 2 \pi f t ) + \underbrace{A \sin( \phi )}_{\alpha_c} \cdot \cos ( 2 \pi f t ) \\
    &= \alpha_s \cdot \sin ( 2 \pi f t ) + \alpha_c \cdot \cos ( 2 \pi f t ) 
\end{align*}

We have transformed this from something that is not linear in the parameters $A$ and $\phi$ to an expression that is linear in the parameters $\alpha_s$ and $\alpha_c$.

If we denote the frequency as $f = \frac{i}{s}$, where $s$ is the number of seasons in a cycle and $i$ is a given integer, where $i = 1, 2, 3, \ldots, \left\lfloor \frac{s}{2} \right\rfloor$, we get:

\begin{align*}
  A \sin \left( \frac{2 \pi i t}{s} + \phi \right)
    &= \underbrace{A \cos( \phi )}_{\alpha_s} \cdot \sin \left( \frac{2 \pi i t}{s} \right) + \underbrace{A \sin( \phi )}_{\alpha_c} \cdot \cos \left( \frac{2 \pi i t}{s} \right) \\
    &= \alpha_s \cdot \sin \left( \frac{2 \pi i t}{s} \right) + \alpha_c \cdot \cos \left( \frac{2 \pi i t}{s} \right) 
\end{align*}

### Fourier Series

::: {.callout-note title="Fourier Series"}
The **Fourier Series** is an infinite series representation of a smooth function $f(t)$ with period $s$:
$$
  f(t) = \frac{A_0}{2} + \sum_{i=1}^{\infty} \left\{ A_i \sin \left( \frac{2\pi i t}{s} \right) + B_i \cos \left( \frac{2\pi i t}{s} \right) \right\}
$$
The coefficients $A_i$ and $B_i$ are defined by the integrals:
$$
  A_i = \frac{2}{s} \int_0^s f(t) \cos \left( \frac{2\pi i t}{s} \right) \; dt
  ~~~~~~~~~~~~~~~~~~
  B_i = \frac{2}{s} \int_0^s f(t) \sin \left( \frac{2\pi i t}{s} \right) \; dt
$$

:::

The function $f(t)$ can be approximated to any desired level of precision by truncating the series after a sufficient number of terms.

The Fourier Series exists for any smooth (continuously differentiable) function. Note that this allows us to obtain the value of the function at any real value. 
For a time series with $s$ seasons, we are only need to evaluate the function at a finite number of points: 
$t = 1, 2, 3, \ldots, s-1, s$. Hence, we only need to obtain $\left\lfloor \frac{s}{2} \right\rfloor$ terms of this sum to fit the values perfectly. 

| Pattern            | Periods per Cycle, $s$ | Maximum terms in the sum, $\left\lfloor \frac{s}{2} \right\rfloor$ |
|--------------------|------------------------|------------------------|
| Days in a Week     | 7                      | 3                      |
| Quarters in a Year | 4                      | 2                      |
| Months in a Year   | 12                     | 6                      |

: A few examples of seasonal patterns and the corresponding values of $s$ and $\left\lfloor \frac{s}{2} \right\rfloor$ {#tbl-sAndFloorFunction}

Note that if $s$ is even, when $i=\frac{s}{2}$, 
$$
  \sin \left( \frac{2\pi i t}{s} \right) = 0
$$
for all integer values of $t$. So, this term can be omitted from the model.

We can usually get a good approximation with only a few terms.

For a time series with $s$ seasons per cycle, our additive model can be written as:

\begin{align*}
  x_t
    &= m_t + s_t + z_t \\
    &= m_t +
        \sum_{i=1}^{\left\lfloor \frac{s}{2} \right\rfloor} \left\{ A_i \sin \left( \frac{2\pi i t}{s} \right) + B_i \cos \left( \frac{2\pi i t}{s} \right) \right\}
      + z_t
\end{align*}

The term $m_t$ can take a variety of forms, including:

-   Linear:       $~~~~~~~~~~~$ $m_t = \alpha_0 + \alpha_1 t$
-   Quadratic:    $~~~~~~$ $m_t = \alpha_0 + \alpha_1 t + \alpha_2 t^2$
-   Exponential:  $~~~$ $m_t = \alpha_0 e^{\alpha_1 t}$
-   Any other functional form

The term $z_t$ is a (possibly autocorrelated) time series with mean zero.

We will now focus on the seasonal term, $s_t$.
The full seasonal term when considering 12 months in a year is:

\begin{align*}
  s_t 
    &= \sum_{i=1}^{\left\lfloor \frac{s}{2} \right\rfloor} \left\{ A_i \sin \left( \frac{2\pi i t}{s} \right) + B_i \cos \left( \frac{2\pi i t}{s} \right) \right\} \\
    &= \sum_{i=1}^{6} \left\{ A_i \sin \left( \frac{2\pi i t}{12} \right) + B_i \cos \left( \frac{2\pi i t}{12} \right) \right\} \\
    &=~~~~ \left\{ A_1 \sin \left( \frac{2\pi \cdot 1 t}{12} \right) + B_1 \cos \left( \frac{2\pi \cdot 1 t}{12} \right) \right\} & \leftarrow i = 1 \\
    &~~~~~+ \left\{ A_2 \sin \left( \frac{2\pi \cdot 2 t}{12} \right) + B_2 \cos \left( \frac{2\pi \cdot 2 t}{12} \right) \right\} & \leftarrow i = 2 \\
    &~~~~~+ \left\{ A_3 \sin \left( \frac{2\pi \cdot 3 t}{12} \right) + B_3 \cos \left( \frac{2\pi \cdot 3 t}{12} \right) \right\} & \leftarrow i = 3 \\
    &~~~~~+ \left\{ A_4 \sin \left( \frac{2\pi \cdot 4 t}{12} \right) + B_4 \cos \left( \frac{2\pi \cdot 4 t}{12} \right) \right\} & \leftarrow i = 4 \\
    &~~~~~+ \left\{ A_5 \sin \left( \frac{2\pi \cdot 5 t}{12} \right) + B_5 \cos \left( \frac{2\pi \cdot 5 t}{12} \right) \right\} & \leftarrow i = 5 \\
    &~~~~~+ \left\{ A_6 \sin \left( \frac{2\pi \cdot 6 t}{12} \right) + B_6 \cos \left( \frac{2\pi \cdot 6 t}{12} \right) \right\} & \leftarrow i = 6 \\
    &=~~~~ \left\{ A_1 \sin \left( \frac{2\pi \cdot 1 t}{12} \right) + B_1 \cos \left( \frac{2\pi \cdot 1 t}{12} \right) \right\}  \\
    &~~~~~+ \left\{ A_2 \sin \left( \frac{2\pi \cdot 2 t}{12} \right) + B_2 \cos \left( \frac{2\pi \cdot 2 t}{12} \right) \right\} \\
    &~~~~~+ \left\{ A_3 \sin \left( \frac{2\pi \cdot 3 t}{12} \right) + B_3 \cos \left( \frac{2\pi \cdot 3 t}{12} \right) \right\} \\
    &~~~~~+ \left\{ A_4 \sin \left( \frac{2\pi \cdot 4 t}{12} \right) + B_4 \cos \left( \frac{2\pi \cdot 4 t}{12} \right) \right\} \\
    &~~~~~+ \left\{ A_5 \sin \left( \frac{2\pi \cdot 5 t}{12} \right) + B_5 \cos \left( \frac{2\pi \cdot 5 t}{12} \right) \right\} \\
    &~~~~~+ \left\{ \phantom{A_6 \sin \left( \frac{2\pi \cdot 6 t}{12} \right) +}~~ B_6 \cos \left( \frac{2\pi \cdot 6 t}{12} \right) \right\} \\
\end{align*}

Note that $\sin \left( \frac{2\pi \cdot 6 t}{12} \right) = 0$ for all integer values of $t$, so we can omit the term $A_6 \sin \left( \frac{2\pi \cdot 6 t}{12} \right)$.

We can often use a small subset of these terms to get a good approximation of the seasonal component.

### Example: Monthly Average High Temperature in Rexburg


```{r}
weather_df <- rio::import("data/rexburg_weather_monthly.csv") |>
  mutate(dates = my(date_text)) |>
  filter(dates >= my("1/2008")) |>
  rename(x = avg_daily_high_temp) |>
  mutate(TIME = 1:n()) |>
  mutate(
    cos1 = cos(2 * pi * 1 * TIME/12),
    cos2 = cos(2 * pi * 2 * TIME/12),
    cos3 = cos(2 * pi * 3 * TIME/12),
    cos4 = cos(2 * pi * 4 * TIME/12),
    cos5 = cos(2 * pi * 5 * TIME/12),
    cos6 = cos(2 * pi * 6 * TIME/12),
    sin1 = sin(2 * pi * 1 * TIME/12),
    sin2 = sin(2 * pi * 2 * TIME/12),
    sin3 = sin(2 * pi * 3 * TIME/12),
    sin4 = sin(2 * pi * 4 * TIME/12),
    sin5 = sin(2 * pi * 5 * TIME/12),
    sin6 = sin(2 * pi * 6 * TIME/12)) |>
  as_tsibble(index = TIME)

dat_lm1 <- weather_df |>
  model(full = TSLM(x ~ TIME +
    cos1 + sin1 + cos2 + sin2 + cos3 + sin3 +
    cos4 + sin4 + cos5 + sin5 + cos6 ))

dat_lm1 |>
  tidy() |>
  mutate(t = estimate / std.error) |>
  mutate(sig = p.value < 0.05)
  # pull(t)

dat_lm2 <- weather_df |>
  model(reduced  = TSLM(x ~ TIME + sin1 + sin2))

dat_lm2 |>
  tidy() |>
  mutate(t = estimate / std.error) 
# |>
#   pull(`estimate/std.error`)

dat_lm2 |>
  tidy() |>
  pull(estimate)

model_three <- weather_df |>
  model(
    full = TSLM(x ~ TIME + I(TIME^2) +
      cos1 + sin1 + cos2 + sin2 + cos3 + sin3 +
      cos4 + sin4 + cos5 + cos6 + sin6),
    reduced  = TSLM(x ~ I(TIME^2) + sin1 + sin2),
    third = TSLM(x ~ TIME + I(TIME^2) + sin1 + sin2 + sin4 + cos4))

glance(model_three) |> select(.model, AIC, AICc, BIC)
```



# Continue from pg. 102



<!-- Beginning of two columns -->
::: columns
::: {.column width="45%"}

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| label: fig-namegoeshereAlso
#| fig-cap: "Title goes here"

create_sine_df <- function(i, cycle_length = 12) {
  df <- tibble(
    t = seq(from = 0, to = cycle_length, length.out = 501),
    value = sin(2 * pi * i * t / cycle_length),
    i = right(paste0(" ", as.character(i)), 2)
  )
}

sine_df <- create_sine_df(i = 1)
for (i in 2:6) {
  sine_df <- sine_df |> bind_rows(create_sine_df(i))
}

ggplot(sine_df, aes(x = t, y = 28 + value - 4*as.numeric(i), color = i)) +
  geom_line() +
  # geom_point(data = data.frame(x = 1:6, y = seq(4,24,4)), aes(x=x, y=y)) +
  scale_y_continuous(
    breaks = seq(4,24,4),
    minor_breaks = NULL,
    labels = NULL
  ) +
  scale_x_continuous(
    breaks = c(0:12),
    minor_breaks = NULL
  ) +
  scale_color_discrete(name = "i") +
  labs(x = "t", y = "Sine Value", title = "Sine Functions with Different Periods") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  )
```

:::

::: {.column width="10%"}
<!-- empty column to create gap -->
:::

::: {.column width="45%"}

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| label: fig-namegoeshere
#| fig-cap: "Title goes here"

create_cosine_df <- function(i, cycle_length = 12) {
  df <- tibble(
    t = seq(from = 0, to = cycle_length, length.out = 501),
    value = cos(2 * pi * i * t / cycle_length),
    i = right(paste0(" ", as.character(i)), 2)
  )
}

cosine_df <- create_cosine_df(i = 1)
for (i in 2:6) {
  cosine_df <- cosine_df |> bind_rows(create_cosine_df(i))
}

ggplot(cosine_df, aes(x = t, y = 28 + value - 4*as.numeric(i), color = i)) +
  geom_line() +
  # geom_point(data = data.frame(x = 1:6, y = seq(4,24,4)), aes(x=x, y=y)) +
  scale_y_continuous(
    breaks = seq(4,24,4),
    minor_breaks = NULL,
    labels = NULL
  ) +
  scale_x_continuous(
    breaks = c(0:12),
    minor_breaks = NULL
  ) +
  scale_color_discrete(name = "i") +
  labs(x = "t", y = "Cosine Value", title = "Cosine Functions with Different Periods") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  )
```

:::
:::
<!-- End of two columns -->



```{r}
temps_ts <- rio::import("data/global_temparature.csv") |>
  as_tsibble(index = year) |>
  filter(year >= 1970)

temps_ts |> autoplot(.vars = change) +
    labs(
      x = "Year",
      y = "Temperature Change (Celsius)",
      title = paste0("Change in Mean Annual Global Temperature (", min(temps_ts$year), "-", max(temps_ts$year), ")")
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(hjust = 0.5)
    ) + 
  geom_smooth(method='lm', formula= y~x)
```



## Simulation

The following simulation illustrates harmonic seasonal terms.

```{=html}
 <iframe id="harmonicSeasons" src="https://posit.byui.edu/content/3fcf5813-76fe-44ee-ab7f-b4a99884c855" style="border: none; width: 100%; height: 1200px" frameborder="0"></iframe>
```

## Class Activity: SectionTitle (xxx min)

In the previous lesson, we learned how to incorporate an indicator (or dummy) variable for each season in a period. If there are twelve months in a year, this requires having twelve parameters in the model. Given that many seasonal changes are gradual and can be modeled by a continuous function, we can use sines and cosines to approximate the seasonal variation. This can lead to a smaller number of parameters than is required for the indicator variable approach. 

## Small-Group Activity: SectionTitle (xxx min)

<!-- Check your Understanding -->

::: {.callout-tip icon=false title="Check Your Understanding"}

-   Question1
-   Question2

:::





## Homework Preview (5 min)

-   Review upcoming homework assignment
-   Clarify questions




::: {.callout-note icon=false}

## Download Homework

<a href="https://byuistats.github.io/timeseries/homework/homework_5_2.qmd" download="homework_5_2.qmd"> homework_5_2.qmd </a>

:::





<a href="javascript:showhide('Solutions1')"
style="font-size:.8em;">Class Activity</a>
  
::: {#Solutions1 style="display:none;"}
    

:::




<a href="javascript:showhide('Solutions')"
style="font-size:.8em;">Class Activity</a>
  
::: {#Solutions2 style="display:none;"}
    

:::




<a href="javascript:showhide('Solutions3')"
style="font-size:.8em;">Class Activity</a>
  
::: {#Solutions3 style="display:none;"}
    

:::



