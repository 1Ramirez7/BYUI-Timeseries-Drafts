---
title: "Fitted Models and Diagnostic Plots---NEED TO WORK ON THIS"
subtitle: "Chapter 4: Lesson 3"
format: html
editor: source
sidebar: false
---

```{r}
#| include: false
source("common_functions.R")
```

```{=html}
<script type="text/javascript">
 function showhide(id) {
    var e = document.getElementById(id);
    e.style.display = (e.style.display == 'block') ? 'none' : 'block';
 }
 
 function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";
 }    
</script>
```
## Learning Outcomes

{{< include outcomes/chapter_4_lesson_3_outcomes.qmd >}}

## Preparation

-   Read Section 4.4

## Learning Journal Exchange (10 mins)

-   Review another student's journal

-   What would you add to your learning journal after reading another student's?

-   What would you recommend the other student add to their learning journal?

-   Sign the Learning Journal review sheet for your peer

## Class Activity: Fitting a Holt-Winters Model (When First Differences Leave Additional Correlations)

Consider the rate of exchange for one U.S. dollar (USD) to Canadian dollars. Here is a time plot of this exchange rate.

<!-- Monthly exchange rates -->

<!-- ```{r} -->

<!-- usd1_ts <- rio::import("data/exchange_rates_bank_of_canada_monthly.csv", skip = 39) |> -->

<!--   rename(rate = FXMUSDCAD) |> -->

<!--   mutate(date = mdy(date)) |> -->

<!--   mutate(diff = rate - lag(rate)) |> -->

<!--   na.omit() |> -->

<!--   as_tsibble(index = date) -->

<!-- usd1_ts -->

<!-- ``` -->

```{r}
#| code-fold: true
#| code-summary: "Show the code"
usd1_ts <- rio::import("data/exchange_rates_USD_CAD_quarterly.csv") |>
  rename(
    rate = "Exchange Rate",
    date = "Record Date"
  ) |>
  mutate(date = mdy(date)) |>
  as_tsibble(index = date)

usd1_ts <- rio::import("data/exchange_rates.parquet") |>
  filter(currency == "USD.RUB") |>
  mutate(diff = rate - lag(rate)) |>
  as_tsibble(index = date) |>
  na.omit()

usd1_ts |> 
  autoplot(.vars = rate) + 
    labs(
      title = "Converstion Rate for 1 USD to Canadian Dollars",
      subtitle = 
        paste0(
          format(min(usd1_ts$date), "%d %b %Y"),
            " - ",
          format(max(usd1_ts$date), "%d %b %Y")
          ),
      x = "Date",
      y = "Conversion Rate",
    ) +
    theme(
      plot.title = element_text(hjust = 0.5),
      plot.subtitle = element_text(hjust = 0.5)
    )
```

The exchange rates between countries varies over time. It is reasonable to conclude that this time series is non-stationary. We take the first differences of the values to try to remove the non-stationarity.

```{r}
#| code-fold: true
#| code-summary: "Show the code"

usd1_ts |> 
  autoplot(.vars = diff) + 
    labs(
      title = "First Differences of the USD:CAD Converstion Rate",
      subtitle = 
        paste0(
          format(min(usd1_ts$date), "%d %b %Y"),
            " - ",
          format(max(usd1_ts$date), "%d %b %Y")
          ),
      x = "Date",
      y = "Conversion Rate",
    ) +
    theme(
      plot.title = element_text(hjust = 0.5),
      plot.subtitle = element_text(hjust = 0.5)
    )

```

We use the autocorrelation function to determine if the first differences are sufficient to model the exchange rate.

```{r}
#| code-fold: true
#| code-summary: "Show the code"

acf(usd1_ts$diff, main = paste("ACF of First Difference of", usd1_ts$currency[1]))

```

There is still a significant autocorrelation for $k=1$, but for $k>1$, the correlation is not significant--except possibly some spurious results. This suggests we need to do something else (besides a first difference) to model this time series.

```{r}
z_hw <- usd1_ts |>
    model(Additive = ETS(rate ~
        trend("A", alpha = 1) +
        error("A") + season("N", gamma = 0),
        opt_crit = "amse", nmse = 1)) |>
        residuals()
acf(z_hw$.resid) 
```

# Random walk with drift was here...Kilroy...

# What to do with the stuff below this line????

## Class Activity: Fitting a Holt-Winters Model and Connecting it to the Backward Shift Operator (15 min)

## Class Activity: Fitting a Random Walk with Drift (15 min)

## Small Group Activity: Fitting a Random Walk with Drift (20 min)

<!-- Check your Understanding -->

::: {.callout-tip icon="false" title="Check Your Understanding"}
-   Question1
-   Question2
:::

## Homework Preview (5 min)

-   Review upcoming homework assignment
-   Clarify questions

::: {.callout-note icon="false"}
## Download Homework

<a href="https://byuistats.github.io/timeseries/homework/homework_4_3.qmd" download="homework_4_3.qmd"> homework_4_3.qmd </a>
:::

<a href="javascript:showhide('Solutions1')"
style="font-size:.8em;">Class Activity</a>

::: {#Solutions1 style="display:none;"}
:::

<a href="javascript:showhide('Solutions')"
style="font-size:.8em;">Class Activity</a>

::: {#Solutions2 style="display:none;"}
:::

<a href="javascript:showhide('Solutions3')"
style="font-size:.8em;">Class Activity</a>

::: {#Solutions3 style="display:none;"}
:::
